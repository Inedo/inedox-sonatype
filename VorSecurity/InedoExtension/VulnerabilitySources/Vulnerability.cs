using Newtonsoft.Json;
using System;
using System.Collections.Generic;
using System.Linq;
using Inedo.Extensibility.VulnerabilitySources;

namespace Inedo.ProGet.Extensions.VorSecurity.VulnerabilitySources
{
    public sealed partial class VorSecurityVulnerabilitySource
    {
        private sealed partial class PackageVulnerabilities
        {
            [JsonObject]
            public partial struct Vulnerability
            {
                private static readonly DateTimeOffset UnixEpoch = new DateTimeOffset(1970, 1, 1, 0, 0, 0, TimeSpan.Zero);

                [JsonProperty("id")]
                public long ID { get; set; }
                [JsonProperty("resource")]
                public string Resource { get; set; }
                [JsonProperty("title")]
                public string Title { get; set; }
                [JsonProperty("description")]
                public string Description { get; set; }
                [JsonProperty("versions")]
                public IReadOnlyList<string> Versions { get; set; }
                [JsonProperty("references")]
                public IReadOnlyList<string> References { get; set; }
                [JsonProperty("cve")]
                public string CVE { get; set; }
                [JsonProperty("published")]
                public long Published { get; set; }
                [JsonIgnore]
                public DateTimeOffset PublishedDate => UnixEpoch.AddMilliseconds(this.Published);
                [JsonProperty("updated")]
                public long Updated { get; set; }
                [JsonIgnore]
                public DateTimeOffset UpdatedDate => UnixEpoch.AddMilliseconds(this.Updated);
                [JsonProperty("ids")]
                public IReadOnlyDictionary<string, string> IDs { get; set; }

                internal VulnerabilityInfo GetInfo(PackageVulnerabilities packageVulnerabilities, IEnumerable<PackageId> packages)
                {
                    var id = packages.First(packageVulnerabilities.IsMatch);
                    return new VulnerabilityInfoImpl(this, id);
                }
            }
        }
    }
}
